var Unicorn=function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function n(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function r(e){return null==e||0===Object.keys(e).length&&e.constructor===Object}function o(e){return!r(e)}function a(e){return e&&"function"==typeof e}function l(e){return o(e.db)&&o(e.db.pk)&&o(e.db.name)?"".concat(e.db.name,":").concat(e.db.pk):null}function s(e,t){return!!e&&e.indexOf(t)>-1}function u(e,t){return void 0===t&&(t=document),t.querySelector(e)}function d(e,t){for(var i=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1);i.nextNode();)t(i.currentNode)}function c(e,t,i){var n,r=this;return void 0===i&&(i=!0),function(){for(var o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];var s=r,u=function(){n=null,i||e.apply(s,a)},d=i&&!n;clearTimeout(n),n=setTimeout(u,t),d&&e.apply(s,a)}}var h,f=function(){function e(i){t(this,e),this.attribute=i,this.name=this.attribute.name,this.value=this.attribute.value,this.isUnicorn=!1,this.isModel=!1,this.isField=!1,this.isPoll=!1,this.isLoading=!1,this.isTarget=!1,this.isKey=!1,this.isPK=!1,this.isError=!1,this.modifiers={},this.eventType=null,this.init()}return n(e,[{key:"init",value:function(){var e=this;if(this.name.startsWith("unicorn:")||this.name.startsWith("u:")){if(this.isUnicorn=!0,s(this.name,":model"))this.isModel=!0;else if(s(this.name,":field"))this.isField=!0;else if(s(this.name,":db"))this.isDb=!0;else if(s(this.name,":poll.disable"))this.isPollDisable=!0;else if(s(this.name,":poll"))this.isPoll=!0;else if(s(this.name,":loading"))this.isLoading=!0;else if(s(this.name,":target"))this.isTarget=!0;else if("unicorn:key"===this.name||"u:key"===this.name)this.isKey=!0;else if("unicorn:pk"===this.name||"u:pk"===this.name)this.isPK=!0;else if(s(this.name,":error:"))this.isError=!0;else{var t=this.name.replace("unicorn:","").replace("u:","");"id"!==t&&"name"!==t&&"checksum"!==t&&(this.eventType=t)}var i=this.name;this.eventType&&(i=this.eventType),i.split(".").slice(1).forEach((function(t){var i=t.split("-");e.modifiers[i[0]]=!(i.length>1)||i[1],e.eventType&&(e.eventType=e.eventType.replace(".".concat(t),""))}))}}}]),e}(),m=function(){function e(i){t(this,e),this.el=i,this.init()}return n(e,[{key:"init",value:function(){var t=this;if(this.id=this.el.id,this.isUnicorn=!1,this.attributes=[],this.value=this.getValue(),this.parent=null,this.el.parentElement&&(this.parent=new e(this.el.parentElement)),this.model={},this.poll={},this.loading={},this.actions=[],this.db={},this.field={},this.target=null,this.key=null,this.errors=[],this.el.attributes){for(var i=0;i<this.el.attributes.length;i++){var n=new f(this.el.attributes[i]);if(this.attributes.push(n),n.isUnicorn&&(this.isUnicorn=!0),n.isModel)this.model.name=n.value,this.model.eventType=n.modifiers.lazy?"blur":"input",this.model.isLazy=!!n.modifiers.lazy,this.model.isDefer=!!n.modifiers.defer,this.model.debounceTime=n.modifiers.debounce&&parseInt(n.modifiers.debounce,10)||-1;else if(n.isField)this.field.name=n.value,this.field.eventType=n.modifiers.lazy?"blur":"input",this.field.isLazy=!!n.modifiers.lazy,this.field.isDefer=!!n.modifiers.defer,this.field.debounceTime=n.modifiers.debounce&&parseInt(n.modifiers.debounce,10)||-1;else if(n.isDb)this.db.name=n.value;else if(n.isPK)this.db.pk=n.value;else if(n.isPoll){this.poll.method=n.value?n.value:"refresh",this.poll.timing=2e3,this.poll.disable=!1;var a=n.name.split("-").slice(1);a.length>0&&(this.poll.timing=parseInt(a[0],10)||2e3)}else n.isPollDisable?this.poll.disableData=n.value:n.isLoading?n.modifiers.attr?this.loading.attr=n.value:n.modifiers.class&&n.modifiers.remove?this.loading.removeClass=n.value:n.modifiers.class?this.loading.class=n.value:n.modifiers.remove?this.loading.hide=!0:this.loading.show=!0:n.isTarget?this.target=n.value:n.eventType&&function(){var e={};e.name=n.value,e.eventType=n.eventType,e.isPrevent=!1,e.isStop=!1,n.modifiers&&Object.keys(n.modifiers).forEach((function(t){"prevent"===t?e.isPrevent=!0:"stop"===t?e.isStop=!0:e.key=t})),t.actions.push(e)}();if(n.isKey&&(this.key=n.value),n.isError){var l=n.name.replace("unicorn:error:","");this.errors.push({code:l,message:n.value})}}if(this.isUnicorn&&o(this.field)){var s=this;for(["pk","name"].forEach((function(e){for(s=t;r(t.db[e])&&!s.el.getAttribute("unicorn:checksum");)s.isUnicorn&&o(s.db[e])&&(t.db[e]=s.db[e]),s=s.parent})),s=this;r(this.model.name)&&!s.el.getAttribute("unicorn:checksum");)s.isUnicorn&&o(s.model.name)&&(o(this.field)&&r(this.db)?(this.model=this.field,this.model.name="".concat(s.model.name,".").concat(this.field.name),this.field={}):this.model.name=s.model.name),s=s.parent}}}},{key:"focus",value:function(){this.el.focus()}},{key:"hide",value:function(){this.el.hidden="hidden"}},{key:"show",value:function(){this.el.hidden=null}},{key:"dbKey",value:function(){return l(this)}},{key:"getUnicornParent",value:function(){for(var e=this.parent;e&&!e.isUnicorn;){if(e.el.getAttribute("unicorn:checksum"))return null;e=e.parent}return e}},{key:"handleLoading",value:function(){this.loading&&(this.loading.attr?this.el[this.loading.attr]=this.loading.attr:this.loading.class?this.el.classList.add(this.loading.class):this.loading.removeClass&&this.el.classList.remove(this.loading.removeClass))}},{key:"isSame",value:function(e){return this.el.isSameNode(e.el)}},{key:"getValue",value:function(){var e=this.el.value;if(this.el.type)if("checkbox"===this.el.type.toLowerCase())e=this.el.checked;else if("select-multiple"===this.el.type.toLowerCase()){e=[];for(var t=0;t<this.el.selectedOptions.length;t++)e.push(this.el.selectedOptions[t].value)}return e}},{key:"setValue",value:function(e){r(this.el.type)||("radio"===this.el.type.toLowerCase()?this.el.value===e&&(this.el.checked=!0):"checkbox"===this.el.type.toLowerCase()?this.el.checked=e:this.el.value=e)}},{key:"addError",value:function(e){this.errors.push(e),this.el.setAttribute("unicorn:error:".concat(e.code),e.message)}},{key:"removeErrors",value:function(){var e=this;this.errors.forEach((function(t){e.el.removeAttribute("unicorn:error:".concat(t.code))})),this.errors=[]}}]),e}();var p="undefined"==typeof document?void 0:document,v=!!p&&"content"in p.createElement("template"),g=!!p&&p.createRange&&"createContextualFragment"in p.createRange();function y(e){return e=e.trim(),v?function(e){var t=p.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):g?function(e){return h||(h=p.createRange()).selectNode(p.body),h.createContextualFragment(e).childNodes[0]}(e):function(e){var t=p.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function b(e,t){var i,n,r=e.nodeName,o=t.nodeName;return r===o||(i=r.charCodeAt(0),n=o.charCodeAt(0),i<=90&&n>=97?r===o.toUpperCase():n<=90&&i>=97&&o===r.toUpperCase())}function E(e,t,i){e[i]!==t[i]&&(e[i]=t[i],e[i]?e.setAttribute(i,""):e.removeAttribute(i))}var k={OPTION:function(e,t){var i=e.parentNode;if(i){var n=i.nodeName.toUpperCase();"OPTGROUP"===n&&(n=(i=i.parentNode)&&i.nodeName.toUpperCase()),"SELECT"!==n||i.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),i.selectedIndex=-1)}E(e,t,"selected")},INPUT:function(e,t){E(e,t,"checked"),E(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var i=t.value;e.value!==i&&(e.value=i);var n=e.firstChild;if(n){var r=n.nodeValue;if(r==i||!i&&r==e.placeholder)return;n.nodeValue=i}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var i,n,r=-1,o=0,a=e.firstChild;a;)if("OPTGROUP"===(n=a.nodeName&&a.nodeName.toUpperCase()))a=(i=a).firstChild;else{if("OPTION"===n){if(a.hasAttribute("selected")){r=o;break}o++}!(a=a.nextSibling)&&i&&(a=i.nextSibling,i=null)}e.selectedIndex=r}}};function T(){}function N(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var w=function(e){return function(t,i,n){if(n||(n={}),"string"==typeof i)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var r=i;(i=p.createElement("html")).innerHTML=r}else i=y(i);var o=n.getNodeKey||N,a=n.onBeforeNodeAdded||T,l=n.onNodeAdded||T,s=n.onBeforeElUpdated||T,u=n.onElUpdated||T,d=n.onBeforeNodeDiscarded||T,c=n.onNodeDiscarded||T,h=n.onBeforeElChildrenUpdated||T,f=!0===n.childrenOnly,m=Object.create(null),v=[];function g(e){v.push(e)}function E(e,t){if(1===e.nodeType)for(var i=e.firstChild;i;){var n=void 0;t&&(n=o(i))?g(n):(c(i),i.firstChild&&E(i,t)),i=i.nextSibling}}function w(e,t,i){!1!==d(e)&&(t&&t.removeChild(e),c(e),E(e,i))}function A(e){l(e);for(var t=e.firstChild;t;){var i=t.nextSibling,n=o(t);if(n){var r=m[n];r&&b(t,r)?(t.parentNode.replaceChild(r,t),S(r,t)):A(t)}else A(t);t=i}}function S(t,i,n){var r=o(i);if(r&&delete m[r],!n){if(!1===s(t,i))return;if(e(t,i),u(t),!1===h(t,i))return}"TEXTAREA"!==t.nodeName?function(e,t){var i,n,r,l,s,u=t.firstChild,d=e.firstChild;e:for(;u;){for(l=u.nextSibling,i=o(u);d;){if(r=d.nextSibling,u.isSameNode&&u.isSameNode(d)){u=l,d=r;continue e}n=o(d);var c=d.nodeType,h=void 0;if(c===u.nodeType&&(1===c?(i?i!==n&&((s=m[i])?r===s?h=!1:(e.insertBefore(s,d),n?g(n):w(d,e,!0),d=s):h=!1):n&&(h=!1),(h=!1!==h&&b(d,u))&&S(d,u)):3!==c&&8!=c||(h=!0,d.nodeValue!==u.nodeValue&&(d.nodeValue=u.nodeValue))),h){u=l,d=r;continue e}n?g(n):w(d,e,!0),d=r}if(i&&(s=m[i])&&b(s,u))e.appendChild(s),S(s,u);else{var f=a(u);!1!==f&&(f&&(u=f),u.actualize&&(u=u.actualize(e.ownerDocument||p)),e.appendChild(u),A(u))}u=l,d=r}!function(e,t,i){for(;t;){var n=t.nextSibling;(i=o(t))?g(i):w(t,e,!0),t=n}}(e,d,n);var v=k[e.nodeName];v&&v(e,t)}(t,i):t.innerHTML!=i.innerHTML&&k.TEXTAREA(t,i)}!function e(t){if(1===t.nodeType||11===t.nodeType)for(var i=t.firstChild;i;){var n=o(i);n&&(m[n]=i),e(i),i=i.nextSibling}}(t);var C,V,U=t,M=U.nodeType,P=i.nodeType;if(!f)if(1===M)1===P?b(t,i)||(c(t),U=function(e,t){for(var i=e.firstChild;i;){var n=i.nextSibling;t.appendChild(i),i=n}return t}(t,(C=i.nodeName,(V=i.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==V?p.createElementNS(V,C):p.createElement(C)))):U=i;else if(3===M||8===M){if(P===M)return U.nodeValue!==i.nodeValue&&(U.nodeValue=i.nodeValue),U;U=i}if(U===i)c(t);else{if(i.isSameNode&&i.isSameNode(U))return;if(S(U,i,f),v)for(var L=0,D=v.length;L<D;L++){var O=m[v[L]];O&&w(O,O.parentNode,!1)}}return!f&&U!==t&&t.parentNode&&(U.actualize&&(U=U.actualize(t.ownerDocument||p)),t.parentNode.replaceChild(U,t)),U}}((function(e,t){var i,n,r,o,a=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var l=a.length-1;l>=0;l--)n=(i=a[l]).name,r=i.namespaceURI,o=i.value,r?(n=i.localName||n,e.getAttributeNS(r,n)!==o&&("xmlns"===i.prefix&&(n=i.name),e.setAttributeNS(r,n,o))):e.getAttribute(n)!==o&&e.setAttribute(n,o);for(var s=e.attributes,u=s.length-1;u>=0;u--)n=(i=s[u]).name,(r=i.namespaceURI)?(n=i.localName||n,t.hasAttributeNS(r,n)||e.removeAttributeNS(r,n)):t.hasAttribute(n)||e.removeAttribute(n)}})),A={childrenOnly:!1,getNodeKey:function(e){if(e.attributes){var t=e.getAttribute("unicorn:key")||e.getAttribute("u:key")||e.id;if(t)return t}},onBeforeElUpdated:function(e,t){if(e.isEqualNode(t))return!1}};function S(e,t){if(0!==e.actionQueue.length&&e.currentActionQueue!==e.actionQueue){e.currentActionQueue=e.actionQueue,e.actionQueue=[];var i={id:e.id,data:e.data,checksum:e.checksum,actionQueue:e.currentActionQueue},n={Accept:"application/json","X-Requested-With":"XMLHttpRequest"};n[e.csrfTokenHeaderName]=function(e){var t="csrftoken=",i=e.document.cookie.split(";").filter((function(e){return e.trim().startsWith(t)}));if(i.length>0)return i[0].replace(t,"");var n=e.document.getElementsByName("csrfmiddlewaretoken");if(n&&n.length>0)return n[0].getAttribute("value");throw Error("CSRF token is missing. Do you need to add {% csrf_token %}?")}(e),fetch(e.syncUrl,{method:"POST",headers:n,body:JSON.stringify(i)}).then((function(e){if(e.ok)return e.json();throw Error("Error when getting response: ".concat(e.statusText," (").concat(e.status,")"))})).then((function(i){if(i){if(i.error)throw Error(i.error);i.redirect&&(i.redirect.url?i.redirect.refresh?(i.redirect.title&&(e.window.document.title=i.redirect.title),e.window.history.pushState({},"",i.redirect.url)):e.window.location.href=i.redirect.url:i.redirect.hash&&(e.window.location.hash=i.redirect.hash)),e.modelEls.forEach((function(e){e.init(),e.removeErrors()})),e.data=i.data||{},e.errors=i.errors||{},e.return=i.return||{};var n=i.dom,r=i.poll||{};o(r)&&(e.poll.timer&&clearInterval(e.poll.timer),r.timing&&(e.poll.timing=r.timing),r.method&&(e.poll.method=r.method),e.poll.disable=r.disable||!1,e.startPolling()),w(e.root,n,A),e.refreshChecksum(),e.refreshEventListeners(),e.modelEls.forEach((function(t){Object.keys(e.errors).forEach((function(i){if(t.model.name===i){var n=e.errors[i][0];t.addError(n)}}))}));var l=e.lastTriggeringElements;e.lastTriggeringElements=[],e.currentActionQueue=null,a(t)&&t(l,null)}})).catch((function(i){e.actionQueue=[],e.currentActionQueue=null,e.lastTriggeringElements=[],a(t)&&t(null,null,i)}))}}function C(e,t){t.handleLoading(),e.loadingEls.forEach((function(i){if(i.target){var n=u("#".concat(i.target),e.root);n||e.keyEls.forEach((function(e){n||e.key!==i.target||(n=e.el)})),n&&t.el.isSameNode(n)&&(i.loading.hide?i.hide():i.loading.show&&i.show())}else i.loading.hide?i.hide():i.loading.show&&i.show()}))}function V(e,t,i){return(t=t.trim().slice(t.indexOf(i)+i.length).trim()).split(".").forEach((function(t){if(t=t.trim())if(t.endsWith("()")){var i=t.slice(0,t.length-2);e=e[i]()}else{if(!o(e[t]))throw Error("'".concat(t,"' could not be retrieved"));e=e[t]}})),"string"==typeof e&&(e='"'.concat(e,'"')),e}function U(e,t){e.document.addEventListener(t,(function(i){var n=new m(i.target);n&&!n.isUnicorn&&(n=n.getUnicornParent()),n&&n.isUnicorn&&n.actions.length>0&&e.actionEvents[t].forEach((function(t){var a=t.action,l=t.element;n.isSame(l)&&(e.walker(l.el,(function(t){e.modelEls.filter((function(e){return e.el.isSameNode(t)})).forEach((function(t){if(o(t.model)&&t.model.isLazy){var i={type:"syncInput",payload:{name:t.model.name,value:t.getValue()}};e.actionQueue.push(i)}})),e.dbEls.filter((function(e){return e.el.isSameNode(t)})).forEach((function(t){if(o(t.model)&&t.model.isLazy){var i={type:"dbInput",payload:{model:t.model.name,db:t.db.name,pk:t.db.pk,fields:{}}};i.payload.fields[t.field.name]=t.getValue(),e.actionQueue.push(i)}}))})),a.isPrevent&&i.preventDefault(),a.isStop&&i.stopPropagation(),function(e){if(!s(e=e.trim(),"(")||!e.endsWith(")"))return[];e=e.slice(e.indexOf("(")+1,e.length-1);for(var t=[],i="",n=!1,r=!1,o=0,a=0,l=0;l<e.length;l++){var u=e.charAt(l);i+=u,"["===u?a++:"]"===u?a--:"("===u?o++:")"===u?o--:"{"===u||"}"===u||("'"===u?n=!n:'"'===u?r=!r:","===u&&(n||r||0!==a||0!==o||(i=i.slice(0,i.length-1),t.push(i),i=""))),l===e.length-1&&(n||r||0!==a||0!==o||(t.push(i.trim()),i=""))}return t}(a.name).forEach((function(t){if(t.startsWith("$event"))try{var l=V(i,t,"$event");a.name=a.name.replace(t,l)}catch(e){a.name=a.name.replace(t,"")}else if(t.startsWith("$returnValue"))if(o(e.return)&&o(e.return.value))try{var s=V(e.return.value,t,"$returnValue");a.name=a.name.replace(t,s)}catch(e){a.name=a.name.replace(t,"")}else a.name=a.name.replace(t,"");else if("$model"===t){for(var u={},d=n;d.parent&&(r(u.name)||r(u.pk))&&!d.el.getAttribute("unicorn:checksum");)d.db.name&&(u.name=d.db.name),d.db.pk&&(u.pk=d.db.pk),d=d.parent;u.name&&u.pk&&(a.name=a.name.replace("$model",JSON.stringify({pk:u.pk,name:u.name})))}})),a.key?a.key===function(e){if(!e)return"";var t=e.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g);return t?t.map((function(e){return e.toLowerCase()})).join("-"):e}(i.key)&&(C(e,n),e.callMethod(a.name)):(C(e,n),e.callMethod(a.name)))}))}))}var M=function(){function e(i){if(t(this,e),this.id=i.id,this.name=i.name,this.key=i.key,this.messageUrl=i.messageUrl,this.csrfTokenHeaderName=i.csrfTokenHeaderName,s(this.name,".")){var n=this.name.split(".");this.name=n[n.length-2]}this.data=i.data,this.syncUrl="".concat(this.messageUrl,"/").concat(this.name),this.document=i.document||document,this.walker=i.walker||d,this.window=i.window||window,this.root=void 0,this.modelEls=[],this.dbEls=[],this.loadingEls=[],this.keyEls=[],this.errors={},this.return={},this.poll={},this.actionQueue=[],this.currentActionQueue=null,this.lastTriggeringElements=[],this.actionEvents={},this.attachedEventTypes=[],this.attachedModelEvents=[],this.attachedDbEvents=[],this.init(),this.refreshEventListeners(),this.initPolling()}return n(e,[{key:"init",value:function(){if(this.root=u('[unicorn\\:id="'.concat(this.id,'"]'),this.document),!this.root)throw Error("No id found");this.refreshChecksum()}},{key:"refreshEventListeners",value:function(){var e=this;this.actionEvents={},this.modelEls=[],this.dbEls=[],this.walker(this.root,(function(t){if(!t.isSameNode(e.root)){var i=new m(t);i.isUnicorn&&(o(i.field)&&(o(i.db)||o(i.model))?(e.attachedDbEvents.some((function(e){return e.isSame(i)}))||(e.attachedDbEvents.push(i),function(e,t,i){t.addEventListener(i,(function(t){var i=new m(t.target);if(!(r(i.db.name)&&r(i.model.name)||r(i.db.pk))){e.lastTriggeringElements.some((function(e){return e.isSame(i)}))||e.lastTriggeringElements.push(i);var n={type:"dbInput",payload:{model:i.model.name,db:i.db,fields:{}}};if(n.payload.fields[i.field.name]=i.getValue(),i.field.isDefer){var o=!1;return e.actionQueue.forEach((function(e){l(e.payload)===i.dbKey()&&(e.payload.fields[i.field.name]=i.getValue(),o=!0)})),void(o||e.actionQueue.push(n))}e.actionQueue.push(n),e.queueMessage(i.model.debounceTime,(function(t,i){i?console.error(i):e.setDbModelValues()}))}}))}(e,i.el,i.field.eventType)),e.dbEls.some((function(e){return e.isSame(i)}))||e.dbEls.push(i)):o(i.model)&&r(i.db)&&r(i.field)?(e.attachedModelEvents.some((function(e){return e.isSame(i)}))||(e.attachedModelEvents.push(i),function(e,t,i){t.addEventListener(i,(function(t){var i=new m(t.target),n={type:"syncInput",payload:{name:i.model.name,value:i.getValue()}};if(e.lastTriggeringElements.some((function(e){return e.isSame(i)}))||e.lastTriggeringElements.push(i),i.model.isDefer){var r=!1;return e.actionQueue.forEach((function(e){e.payload.name===i.model.name&&(e.payload.value=i.getValue(),r=!0)})),void(r||e.actionQueue.push(n))}e.actionQueue.push(n),e.queueMessage(i.model.debounceTime,(function(t,i){i?console.error(i):(e.setModelValues(t),e.setDbModelValues())}))}))}(e,i.el,i.model.eventType)),e.modelEls.some((function(e){return e.isSame(i)}))||e.modelEls.push(i)):o(i.loading)&&(e.loadingEls.push(i),i.loading.show&&i.hide()),o(i.key)&&e.keyEls.push(i),i.actions.forEach((function(t){e.actionEvents[t.eventType]?e.actionEvents[t.eventType].push({action:t,element:i}):(e.actionEvents[t.eventType]=[{action:t,element:i}],e.attachedEventTypes.some((function(e){return e===t.eventType}))||(e.attachedEventTypes.push(t.eventType),U(e,t.eventType)))})))}}))}},{key:"callMethod",value:function(e,t){var i=this,n={type:"callMethod",payload:{name:e}};this.actionQueue.push(n),this.queueMessage(-1,(function(e,n){n&&a(t)?t(n):n?console.error(n):(i.setModelValues(e),i.setDbModelValues())}))}},{key:"handlePollError",value:function(e){e&&console.error(e),this.poll.timer&&clearInterval(this.poll.timer)}},{key:"initPolling",value:function(){var e=this,t=new m(this.root);t.isUnicorn&&o(t.poll)&&(this.poll=t.poll,this.poll.timer=null,this.document.addEventListener("visibilitychange",(function(){e.document.hidden?e.poll.timer&&clearInterval(e.poll.timer):e.startPolling()}),!1),this.callMethod(this.poll.method,this.handlePollError),this.startPolling())}},{key:"startPolling",value:function(){var e=this;this.poll.timer=setInterval((function(){e.poll.disable||(o(e.poll.disableData)?e.poll.disableData.startsWith("!")?(e.poll.disableData=e.poll.disableData.slice(1),e.data[e.poll.disableData]&&e.callMethod(e.poll.method,e.handlePollError),e.poll.disableData="!".concat(e.poll.disableData)):e.data[e.poll.disableData]||e.callMethod(e.poll.method,e.handlePollError):e.callMethod(e.poll.method,e.handlePollError))}),this.poll.timing)}},{key:"refreshChecksum",value:function(){this.checksum=this.root.getAttribute("unicorn:checksum")}},{key:"setValue",value:function(e){r(e.model)||this.setNestedValue(e,e.model.name,this.data)}},{key:"setNestedValue",value:function(e,t,i){for(var n=t.split("."),r=i,o=0;o<n.length;o++){var a=n[o];if(null==r)return;Object.prototype.hasOwnProperty.call(r,a)&&(o===n.length-1?e.setValue(r[a]):r=r[a])}}},{key:"setDbModelValues",value:function(){var e=this;this.dbEls.forEach((function(t){if(""===t.db.pk)t.setValue("");else{if(r(t.model.name))throw Error("Setting a field value requires a model to be set");var i=e.data[t.model.name];Array.isArray(i)||(i=[i]),i.forEach((function(e){o(e.pk)&&e.pk.toString()===t.db.pk&&t.setValue(e[t.field.name])}))}}))}},{key:"setModelValues",value:function(e){var t=this;if((e=e||[]).length>0){var i=!1,n=e.slice(-1)[0];o(n)&&o(n.model)&&!n.model.isLazy&&["id","key"].forEach((function(e){t.modelEls.forEach((function(t){i||n[e]&&n[e]===t[e]&&(t.focus(),i=!0)}))}))}this.modelEls.forEach((function(e){t.setValue(e)}))}},{key:"queueMessage",value:function(e,t){-1===e?c(S,250,!1)(this,t):c(S,e,!1)(this,t)}}]),e}(),P="",L={};function D(e){var t;if(Object.keys(L).forEach((function(i){if(r(t)){var n=L[i];n.key===e&&(t=n)}})),r(t)&&Object.keys(L).forEach((function(i){if(r(t)){var n=L[i];n.name===e&&(t=n)}})),!t)throw Error("No component found for: ".concat(e));return t}return e.call=function(e,t){D(e).callMethod(t,(function(e){console.error(e)}))},e.componentInit=function(e){e.messageUrl=P,e.csrfTokenHeaderName="X-CSRFToken";var t=new M(e);t.init(),L[t.id]=t,t.setModelValues(),t.setDbModelValues()},e.getComponent=D,e.getReturnValue=function(e){return D(e).return.value},e.init=function(e){P=e},e}({});
