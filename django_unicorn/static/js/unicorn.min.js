var Unicorn=function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function r(e){return null==e||0===Object.keys(e).length&&e.constructor===Object}function o(e,t){return!!e&&e.indexOf(t)>-1}function a(e,t){for(var n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1);n.nextNode();)t(n.currentNode)}function s(e,t,n){var i,r=this;return void 0===n&&(n=!0),function(){for(var o=arguments.length,a=new Array(o),s=0;s<o;s++)a[s]=arguments[s];var l=r,u=function(){i=null,n||e.apply(l,a)},c=n&&!i;clearTimeout(i),i=setTimeout(u,t),c&&e.apply(l,a)}}var l,u=function(){function e(n){t(this,e),this.attribute=n,this.name=this.attribute.name,this.value=this.attribute.value,this.isUnicorn=!1,this.isModel=!1,this.isPoll=!1,this.isKey=!1,this.isError=!1,this.modifiers={},this.eventType=null,this.init()}return i(e,[{key:"init",value:function(){var e=this;if(o(this.name,"unicorn:")){if(this.isUnicorn=!0,o(this.name,"unicorn:model"))this.isModel=!0;else if(o(this.name,"unicorn:poll"))this.isPoll=!0;else if("unicorn:key"===this.name)this.isKey=!0;else if(o(this.name,"unicorn:error:"))this.isError=!0;else{var t=this.name.replace("unicorn:","");"id"!==t&&"name"!==t&&"checksum"!==t&&(this.eventType=t)}var n=this.name;this.eventType&&(n=this.eventType),n.split(".").slice(1).forEach((function(t){var n=t.split("-");e.modifiers[n[0]]=!(n.length>1)||n[1],e.eventType&&(e.eventType=e.eventType.replace(".".concat(t),""))}))}}}]),e}(),c=function(){function e(n){t(this,e),this.el=n,this.init()}return i(e,[{key:"init",value:function(){var e=this;if(this.id=this.el.id,this.isUnicorn=!1,this.attributes=[],this.value=this.getValue(),this.model={},this.poll={},this.actions=[],this.key=void 0,this.errors=[],this.el.attributes)for(var t=0;t<this.el.attributes.length;t++){var n=new u(this.el.attributes[t]);if(this.attributes.push(n),n.isUnicorn&&(this.isUnicorn=!0),n.isModel)this.model.name=n.value,this.model.eventType=n.modifiers.lazy?"blur":"input",this.model.isLazy=!!n.modifiers.lazy,this.model.isDefer=!!n.modifiers.defer,this.model.debounceTime=n.modifiers.debounce&&parseInt(n.modifiers.debounce,10)||-1;else if(n.isPoll){this.poll.method=n.value?n.value:"refresh",this.poll.timing=2e3;var i=n.name.split("-").slice(1);i.length>0&&(this.poll.timing=parseInt(i[0],10)||2e3)}else n.eventType&&function(){var t={};t.name=n.value,t.eventType=n.eventType,t.isPrevent=!1,t.isStop=!1,n.modifiers&&Object.keys(n.modifiers).forEach((function(e){"prevent"===e?t.isPrevent=!0:"stop"===e?t.isStop=!0:t.key=e})),e.actions.push(t)}();if(n.isKey&&(this.key=n.value),n.isError){var r=n.name.replace("unicorn:error:","");this.errors.push({code:r,message:n.value})}}}},{key:"focus",value:function(){this.el.focus()}},{key:"getValue",value:function(){var e=this.el.value;if(this.el.type)if("checkbox"===this.el.type.toLowerCase())e=this.el.checked;else if("select-multiple"===this.el.type.toLowerCase()){e=[];for(var t=0;t<this.el.selectedOptions.length;t++)e.push(this.el.selectedOptions[t].value)}return e}},{key:"setValue",value:function(e){"radio"===this.el.type.toLowerCase()?this.el.value===e&&(this.el.checked=!0):"checkbox"===this.el.type.toLowerCase()?this.el.checked=e:this.el.value=e}},{key:"addError",value:function(e){this.errors.push(e),this.el.setAttribute("unicorn:error:".concat(e.code),e.message)}},{key:"removeErrors",value:function(){var e=this;this.errors.forEach((function(t){e.el.removeAttribute("unicorn:error:".concat(t.code))})),this.errors=[]}}]),e}();var d="undefined"==typeof document?void 0:document,h=!!d&&"content"in d.createElement("template"),f=!!d&&d.createRange&&"createContextualFragment"in d.createRange();function v(e){return e=e.trim(),h?function(e){var t=d.createElement("template");return t.innerHTML=e,t.content.childNodes[0]}(e):f?function(e){return l||(l=d.createRange()).selectNode(d.body),l.createContextualFragment(e).childNodes[0]}(e):function(e){var t=d.createElement("body");return t.innerHTML=e,t.childNodes[0]}(e)}function m(e,t){var n,i,r=e.nodeName,o=t.nodeName;return r===o||(n=r.charCodeAt(0),i=o.charCodeAt(0),n<=90&&i>=97?r===o.toUpperCase():i<=90&&n>=97&&o===r.toUpperCase())}function p(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var y={OPTION:function(e,t){var n=e.parentNode;if(n){var i=n.nodeName.toUpperCase();"OPTGROUP"===i&&(i=(n=n.parentNode)&&n.nodeName.toUpperCase()),"SELECT"!==i||n.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),n.selectedIndex=-1)}p(e,t,"selected")},INPUT:function(e,t){p(e,t,"checked"),p(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var i=e.firstChild;if(i){var r=i.nodeValue;if(r==n||!n&&r==e.placeholder)return;i.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,i,r=-1,o=0,a=e.firstChild;a;)if("OPTGROUP"===(i=a.nodeName&&a.nodeName.toUpperCase()))a=(n=a).firstChild;else{if("OPTION"===i){if(a.hasAttribute("selected")){r=o;break}o++}!(a=a.nextSibling)&&n&&(a=n.nextSibling,n=null)}e.selectedIndex=r}}};function E(){}function g(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}var b=function(e){return function(t,n,i){if(i||(i={}),"string"==typeof n)if("#document"===t.nodeName||"HTML"===t.nodeName||"BODY"===t.nodeName){var r=n;(n=d.createElement("html")).innerHTML=r}else n=v(n);var o=i.getNodeKey||g,a=i.onBeforeNodeAdded||E,s=i.onNodeAdded||E,l=i.onBeforeElUpdated||E,u=i.onElUpdated||E,c=i.onBeforeNodeDiscarded||E,h=i.onNodeDiscarded||E,f=i.onBeforeElChildrenUpdated||E,p=!0===i.childrenOnly,b=Object.create(null),k=[];function T(e){k.push(e)}function N(e,t){if(1===e.nodeType)for(var n=e.firstChild;n;){var i=void 0;t&&(i=o(n))?T(i):(h(n),n.firstChild&&N(n,t)),n=n.nextSibling}}function A(e,t,n){!1!==c(e)&&(t&&t.removeChild(e),h(e),N(e,n))}function C(e){s(e);for(var t=e.firstChild;t;){var n=t.nextSibling,i=o(t);if(i){var r=b[i];r&&m(t,r)?(t.parentNode.replaceChild(r,t),S(r,t)):C(t)}else C(t);t=n}}function S(t,n,i){var r=o(n);if(r&&delete b[r],!i){if(!1===l(t,n))return;if(e(t,n),u(t),!1===f(t,n))return}"TEXTAREA"!==t.nodeName?function(e,t){var n,i,r,s,l,u=t.firstChild,c=e.firstChild;e:for(;u;){for(s=u.nextSibling,n=o(u);c;){if(r=c.nextSibling,u.isSameNode&&u.isSameNode(c)){u=s,c=r;continue e}i=o(c);var h=c.nodeType,f=void 0;if(h===u.nodeType&&(1===h?(n?n!==i&&((l=b[n])?r===l?f=!1:(e.insertBefore(l,c),i?T(i):A(c,e,!0),c=l):f=!1):i&&(f=!1),(f=!1!==f&&m(c,u))&&S(c,u)):3!==h&&8!=h||(f=!0,c.nodeValue!==u.nodeValue&&(c.nodeValue=u.nodeValue))),f){u=s,c=r;continue e}i?T(i):A(c,e,!0),c=r}if(n&&(l=b[n])&&m(l,u))e.appendChild(l),S(l,u);else{var v=a(u);!1!==v&&(v&&(u=v),u.actualize&&(u=u.actualize(e.ownerDocument||d)),e.appendChild(u),C(u))}u=s,c=r}!function(e,t,n){for(;t;){var i=t.nextSibling;(n=o(t))?T(n):A(t,e,!0),t=i}}(e,c,i);var p=y[e.nodeName];p&&p(e,t)}(t,n):t.innerHTML!=n.innerHTML&&y.TEXTAREA(t,n)}!function e(t){if(1===t.nodeType||11===t.nodeType)for(var n=t.firstChild;n;){var i=o(n);i&&(b[i]=n),e(n),n=n.nextSibling}}(t);var w,U,M=t,L=M.nodeType,O=n.nodeType;if(!p)if(1===L)1===O?m(t,n)||(h(t),M=function(e,t){for(var n=e.firstChild;n;){var i=n.nextSibling;t.appendChild(n),n=i}return t}(t,(w=n.nodeName,(U=n.namespaceURI)&&"http://www.w3.org/1999/xhtml"!==U?d.createElementNS(U,w):d.createElement(w)))):M=n;else if(3===L||8===L){if(O===L)return M.nodeValue!==n.nodeValue&&(M.nodeValue=n.nodeValue),M;M=n}if(M===n)h(t);else{if(n.isSameNode&&n.isSameNode(M))return;if(S(M,n,p),k)for(var V=0,P=k.length;V<P;V++){var x=b[k[V]];x&&A(x,x.parentNode,!1)}}return!p&&M!==t&&t.parentNode&&(M.actualize&&(M=M.actualize(t.ownerDocument||d)),t.parentNode.replaceChild(M,t)),M}}((function(e,t){var n,i,r,o,a=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var s=a.length-1;s>=0;s--)i=(n=a[s]).name,r=n.namespaceURI,o=n.value,r?(i=n.localName||i,e.getAttributeNS(r,i)!==o&&("xmlns"===n.prefix&&(i=n.name),e.setAttributeNS(r,i,o))):e.getAttribute(i)!==o&&e.setAttribute(i,o);for(var l=e.attributes,u=l.length-1;u>=0;u--)i=(n=l[u]).name,(r=n.namespaceURI)?(i=n.localName||i,t.hasAttributeNS(r,i)||e.removeAttributeNS(r,i)):t.hasAttribute(i)||e.removeAttribute(i)}})),k={childrenOnly:!1,getNodeKey:function(e){if(e.attributes){var t=e.getAttribute("unicorn:key")||e.id;if(t)return t}},onBeforeElUpdated:function(e,t){if(e.isEqualNode(t))return!1}},T=function(){function e(n){if(t(this,e),this.id=n.id,this.name=n.name,this.messageUrl=n.messageUrl,this.csrfTokenHeaderName=n.csrfTokenHeaderName,o(this.name,".")){var i=this.name.split(".");this.name=i[i.length-2]}this.data=n.data,this.syncUrl="".concat(this.messageUrl,"/").concat(this.name),this.document=n.document||document,this.walker=n.walker||a,this.root=void 0,this.modelEls=[],this.errors={},this.poll={},this.actionQueue=[],this.currentActionQueue=null,this.actionEvents={},this.attachedEventTypes=[],this.init(),this.refreshEventListeners(),this.initPolling()}return i(e,[{key:"init",value:function(){var e,t;if(this.root=(e='[unicorn\\:id="'.concat(this.id,'"]'),void 0===(t=this.document)&&(t=document),t.querySelector(e)),!this.root)throw Error("No id found");this.refreshChecksum()}},{key:"addActionEventListener",value:function(e){var t=this;this.document.addEventListener(e,(function(n){var i=new c(n.target);i&&i.isUnicorn&&i.actions.length>0&&t.actionEvents[e].forEach((function(e){if(i.el.isSameNode(e.el)){if(!r(i.model)&&i.model.isLazy){var o={type:"syncInput",payload:{name:i.model.name,value:i.getValue()}};t.actionQueue.push(o)}e.actions.forEach((function(e){var i;e.isPrevent&&n.preventDefault(),e.isStop&&n.stopPropagation(),e.key?e.key===((i=n.key)?i.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g).map((function(e){return e.toLowerCase()})).join("-"):"")&&t.callMethod(e.name):t.callMethod(e.name)}))}}))}))}},{key:"addModelEventListener",value:function(e,t){var n=this;e.el.addEventListener(t,(function(){var t={type:"syncInput",payload:{name:e.model.name,value:e.getValue()}};if(e.model.isDefer){var i=!1;return n.actionQueue.forEach((function(t){t.payload.name===e.model.name&&(t.payload.value=e.getValue(),i=!0)})),void(i||n.actionQueue.push(t))}n.actionQueue.push(t),n.sendMessage(e.model.debounceTime,(function(t,i){i?console.error(i):t?n.setModelValues(e):n.setModelValues()}))}))}},{key:"refreshEventListeners",value:function(){var e=this;this.actionEvents={},this.walker(this.root,(function(t){if(!t.isSameNode(e.root)){var n=new c(t);n.isUnicorn&&(r(n.model)||0===e.modelEls.filter((function(e){return e.el.isSameNode(n.el)})).length&&(e.modelEls.push(n),e.addModelEventListener(n,n.model.eventType)),n.actions.forEach((function(t){e.actionEvents[t.eventType]?e.actionEvents[t.eventType].push(n):(e.actionEvents[t.eventType]=[n],0===e.attachedEventTypes.filter((function(e){return e===t.eventType})).length&&(e.attachedEventTypes.push(t.eventType),e.addActionEventListener(t.eventType)))})))}}))}},{key:"callMethod",value:function(e,t){var n=this,i={type:"callMethod",payload:{name:e,params:[]}};this.actionQueue.push(i),this.sendMessage(-1,(function(e,i){i&&"function"==typeof t?t(i):i?console.error(i):n.setModelValues()}))}},{key:"initPolling",value:function(){var e=this,t=new c(this.root);t.isUnicorn&&!r(t.poll)&&(this.poll=t.poll,this.poll.timer=null,this.document.addEventListener("visibilitychange",(function(){e.document.hidden?e.poll.timer&&clearInterval(e.poll.timer):e.startPolling()}),!1),this.startPolling())}},{key:"startPolling",value:function(){this.poll.timer=null;var e=this.poll.timer;function t(t){t&&console.error(t),e&&clearInterval(e)}this.callMethod(this.poll.method,t),this.poll.timer=setInterval(this.callMethod.bind(this),this.poll.timing,this.poll.method,t)}},{key:"refreshChecksum",value:function(){this.checksum=this.root.getAttribute("unicorn:checksum")}},{key:"setValue",value:function(e){for(var t=e.model.name.split("."),n=this.data,i=0;i<t.length;i++){var r=t[i];Object.prototype.hasOwnProperty.call(n,r)&&(i===t.length-1?e.setValue(n[r]):n=n[r])}}},{key:"setModelValues",value:function(e){var t=this,n=!1;r(e=e||{})||e.model.isLazy||["id","key"].forEach((function(i){t.modelEls.forEach((function(t){n||e[i]&&e[i]===t[i]&&(t.focus(),n=!0)}))})),this.modelEls.forEach((function(n){n.id===e.id&&n.key===e.key||t.setValue(n)}))}},{key:"sendMessage",value:function(e,t){function n(e){if(0!==e.actionQueue.length&&e.currentActionQueue!==e.actionQueue){e.currentActionQueue=e.actionQueue,e.actionQueue=[];var n={id:e.id,data:e.data,checksum:e.checksum,actionQueue:e.currentActionQueue},i={Accept:"application/json","X-Requested-With":"XMLHttpRequest"};i[e.csrfTokenHeaderName]=function(){var e="csrftoken=",t=document.cookie.split(";").filter((function(t){return t.trim().startsWith(e)}));if(t.length>0)return t[0].replace(e,"");var n=document.getElementsByName("csrfmiddlewaretoken");if(n&&n.length>0)return n[0].getAttribute("value");throw Error("CSRF token is missing. Do you need to add {% csrf_token %}?")}(),fetch(e.syncUrl,{method:"POST",headers:i,body:JSON.stringify(n)}).then((function(e){if(e.ok)return e.json();throw Error("Error when getting response: ".concat(e.statusText," (").concat(e.status,")"))})).then((function(n){if(n){if(n.error)throw Error(n.error);e.modelEls.forEach((function(e){e.init(),e.removeErrors()})),e.data=n.data||{},e.errors=n.errors||{};var i=n.dom;b(e.root,i,k),e.refreshChecksum(),e.refreshEventListeners(),e.modelEls.forEach((function(t){Object.keys(e.errors).forEach((function(n){if(t.model.name===n){var i=e.errors[n][0];t.addError(i)}}))}));var r=!1;e.currentActionQueue.forEach((function(e){"callMethod"===e.type&&(r=!0)})),e.currentActionQueue=null,t&&"function"==typeof t&&t(!r,null)}})).catch((function(n){e.actionQueue=[],e.currentActionQueue=null,t&&"function"==typeof t&&t(null,n)}))}}-1===e?s(n,250,!1)(this):s(n,e,!1)(this)}}]),e}(),N="",A={};return e.call=function(e,t){var n;if(Object.keys(A).forEach((function(t){if(void 0===n){var i=A[t];i.name===e&&(n=i)}})),!n)throw Error("No component found for: ",e);n.callMethod(t,(function(e){console.error(e)}))},e.componentInit=function(e){e.messageUrl=N,e.csrfTokenHeaderName="X-CSRFToken";var t=new T(e);t.init(),A[t.id]=t,t.setModelValues()},e.init=function(e){N=e},e}({});
