"use strict";var _createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Unicorn=function(){var e={},i="",o={};function r(e,t){return-1<e.indexOf(t)}function s(e){return void 0===e||0===Object.keys(e).length&&e.constructor===Object}e.init=function(e){i=e};var a=[];function n(t,n){function i(){var e;o=!1,a.length&&(e=a.shift(),r(e))}var o=void 0,r=function(e){o=!0,t(e),setTimeout(i,n)};return function(e){o?a.push(e):r(e)}}var l=(_createClass(t,[{key:"init",value:function(){var e,t,n=this;r(this.name,"unicorn:")&&(this.isUnicorn=!0,r(this.name,"unicorn:model")?this.isModel=!0:r(this.name,"unicorn:poll")?this.isPoll=!0:"unicorn:key"===this.name?this.isKey=!0:r(this.name,"unicorn:error:")?this.isError=!0:"id"!==(e=this.name.replace("unicorn:",""))&&"name"!==e&&"checksum"!==e&&(this.eventType=e),t=this.name,this.eventType&&(t=this.eventType),t.split(".").slice(1).forEach(function(e){var t=e.split("-");n.modifiers[t[0]]=!(1<t.length)||t[1]}))}}]),t);function t(e){_classCallCheck(this,t),this.attribute=e,this.name=this.attribute.name,this.value=this.attribute.value,this.isUnicorn=!1,this.isModel=!1,this.isPoll=!1,this.isKey=!1,this.isError=!1,this.modifiers={},this.eventType=null,this.init()}var c=(_createClass(u,[{key:"init",value:function(){if(this.id=this.el.id,this.isUnicorn=!1,this.attributes=[],this.value=this.getValue(),this.model={},this.poll={},this.action={},this.key=void 0,this.errors=[],this.el.attributes)for(var e=0;e<this.el.attributes.length;e++){var t,n=new l(this.el.attributes[e]);this.attributes.push(n),n.isUnicorn&&(this.isUnicorn=!0),n.isModel?(this.model.name=n.value,this.model.eventType=n.modifiers.lazy?"blur":"input",this.model.isLazy=!!n.modifiers.lazy,this.model.debounceTime=n.modifiers.debounce&&parseInt(n.modifiers.debounce,10)||-1):n.isPoll?(this.poll.method=n.value?n.value:"refresh",this.poll.timing=parseInt(Object.keys(n.modifiers)[0],10)||2e3):n.eventType&&(this.action.name=n.value,this.action.eventType=n.eventType,n.modifiers&&(this.action.key=Object.keys(n.modifiers)[0]),this.action.key&&(this.action.eventType=this.action.eventType.replace("."+this.action.key,""))),n.isKey&&(this.key=n.value),n.isError&&(t=n.name.replace("unicorn:name:",""),this.errors.push({code:t,message:n.value}))}}},{key:"focus",value:function(){this.el.focus()}},{key:"getValue",value:function(){var e=this.el.value;if(this.el.type)if("checkbox"===this.el.type.toLowerCase())e=this.el.checked;else if("select-multiple"===this.el.type.toLowerCase()){e=[];for(var t=0;t<this.el.selectedOptions.length;t++)e.push(this.el.selectedOptions[t].value)}return e}},{key:"setValue",value:function(e){"radio"===this.el.type.toLowerCase()?this.el.value===e&&(this.el.checked=!0):"checkbox"===this.el.type.toLowerCase()?this.el.checked=e:this.el.value=e}},{key:"addError",value:function(e){this.errors.push(e),this.el.setAttribute("unicorn:error:"+e.code,e.message)}},{key:"removeErrors",value:function(){var t=this;this.errors.forEach(function(e){t.el.removeAttribute(e.code)}),this.errors=[]}}]),u);function u(e){_classCallCheck(this,u),this.el=e,this.init()}var d=(_createClass(h,[{key:"init",value:function(){var e,t;if(this.root=(e='[unicorn\\:id="'+this.id+'"]',void 0===t&&(t=document),t.querySelector(e)),!this.root)throw Error("No id found");this.refreshChecksum()}},{key:"refreshEventListeners",value:function(){var n=this;this.modelEvents={},this.actionEvents={},function(e,t){for(var n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1);n.nextNode();)t(n.currentNode)}(this.root,function(e){var t;e.isSameNode(n.root)||(t=new c(e)).isUnicorn&&(s(t.model)||(n.modelEls.push(t),n.modelEvents[t.model.eventType]?n.modelEvents[t.model.eventType].push(t):n.modelEvents[t.model.eventType]=[t]),s(t.action)||(n.actionEvents[t.action.eventType]?n.actionEvents[t.action.eventType].push(t):n.actionEvents[t.action.eventType]=[t]))})}},{key:"callMethod",value:function(e,t){var n=this,i={type:"callMethod",payload:{name:e,params:[]}};this.sendMessage(i,-1,function(e){e&&"function"==typeof t?t(e):e?console.error(e):n.setModelValues()})}},{key:"startPolling",value:function(){function e(e){e&&console.error(e),this.poll.timer&&clearInterval(this.poll.timer)}this.poll.timer=null,this.callMethod(this.poll.method,e),this.poll.timer=setInterval(this.callMethod.bind(this),this.poll.timing,this.poll.method,e)}},{key:"refreshChecksum",value:function(){this.checksum=this.root.getAttribute("unicorn:checksum")}},{key:"setValue",value:function(e){for(var t=e.model.name.split("."),n=this.data,i=0;i<t.length;i++){var o=t[i];Object.prototype.hasOwnProperty.call(n,o)&&(i===t.length-1?e.setValue(n[o]):n=n[o])}}},{key:"setModelValues",value:function(n){var i=this,o=!1;s(n=n||{})||n.model.isLazy||["id","key"].forEach(function(t){i.modelEls.forEach(function(e){o||n[t]&&n[t]===e[t]&&(e.focus(),o=!0)})}),this.modelEls.forEach(function(e){e.id===n.id&&e.key===n.key||i.setValue(e)})}},{key:"sendMessage",value:function(o,e,r){function t(i){var e=[o],t={id:i.id,data:i.data,checksum:i.checksum,actionQueue:e},n={Accept:"application/json","X-Requested-With":"XMLHttpRequest"};n["X-CSRFToken"]=function(){var e=document.getElementsByName("csrfmiddlewaretoken");if(e)return e[0].getAttribute("value");throw Error("CSRF token is missing. Do you need to add {% csrf_token %}?")}(),fetch(i.syncUrl,{method:"POST",headers:n,body:JSON.stringify(t)}).then(function(e){if(e.ok)return e.json();throw Error("Error when getting response: "+e.statusText+" ("+e.status+")")}).then(function(e){if(e){if(e.error)throw Error(e.error);i.modelEls.forEach(function(e){e.init(),e.removeErrors()}),i.data=e.data||{},i.errors=e.errors||{};var t=e.dom;morphdom(i.root,t,{childrenOnly:!1,getNodeKey:function(e){if(e.attributes){var t=e.getAttribute("unicorn:key")||e.id;if(t)return t}},onBeforeElUpdated:function(e,t){if(e.isEqualNode(t))return!1}}),i.refreshChecksum(),i.refreshEventListeners(),i.modelEls.forEach(function(n){Object.keys(i.errors).forEach(function(e){var t;n.model.name===e&&(t=i.errors[e][0],n.addError(t))})}),r&&"function"==typeof r&&r()}}).catch(function(e){r&&"function"==typeof r&&r(e)})}(-1===e?n(t,250):function(r,s,a){var l=this,c=void 0;return void 0===a&&(a=!0),function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=l,o=a&&!c;clearTimeout(c),c=setTimeout(function(){c=null,a||r.apply(i,t)},s),o&&r.apply(i,t)}}(t,e,!1))(this)}}]),h);function h(e){var t,o=this;_classCallCheck(this,h),this.id=e.id,this.name=e.name,r(this.name,".")&&(t=this.name.split("."),this.name=t[t.length-2]),this.data=e.data,this.syncUrl=i+"/"+this.name,this.root=void 0,this.modelEls=[],this.errors={},this.poll={},this.events=[],this.modelEvents={},this.actionEvents={},this.init(),this.refreshEventListeners();var n=new c(this.root);n.isUnicorn&&!s(n.poll)&&(this.poll=n.poll,this.poll.timer=null,document.addEventListener("visibilitychange",function(){document.hidden?o.poll.timer&&clearInterval(o.poll.timer):o.startPolling()},!1),this.startPolling()),Object.keys(this.modelEvents).forEach(function(e){o.modelEvents[e].forEach(function(i){i.el.addEventListener(e,function(e){var t,n=new c(e.target);n&&n.isUnicorn&&!s(n.model)&&n.el.isSameNode(i.el)&&(t={type:"syncInput",payload:{name:i.model.name,value:i.getValue()}},o.sendMessage(t,i.model.debounceTime,function(e){e?console.error(e):o.setModelValues(i)}))})})}),Object.keys(this.actionEvents).forEach(function(e){document.addEventListener(e,function(t){var n=new c(t.target);n&&n.isUnicorn&&!s(n.action)&&o.actionEvents[e].forEach(function(e){!n.el.isSameNode(e.el)||e.action.key&&e.action.key!==t.key.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g).map(function(e){return e.toLowerCase()}).join("-")||o.callMethod(e.action.name)})})})}return e.componentInit=function(e){var t=new d(e);t.init(),(o[t.id]=t).setModelValues()},e.call=function(n,e){var i=void 0;if(Object.keys(o).forEach(function(e){var t;void 0!==i||(t=o[e]).name===n&&(i=t)}),!i)throw Error("No component found for: ",n);i.callMethod(e,function(e){console.error(e)})},e}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).morphdom=t()}(void 0,function(){var s;var S="http://www.w3.org/1999/xhtml",O="undefined"==typeof document?void 0:document,a=!!O&&"content"in O.createElement("template"),l=!!O&&O.createRange&&"createContextualFragment"in O.createRange();function w(e){return e=e.trim(),a?(n=e,(i=O.createElement("template")).innerHTML=n,i.content.childNodes[0]):l?(t=e,s||(s=O.createRange()).selectNode(O.body),s.createContextualFragment(t).childNodes[0]):(o=e,(r=O.createElement("body")).innerHTML=o,r.childNodes[0]);var t,n,i,o,r}function U(e,t){var n,i,o=e.nodeName,r=t.nodeName;return o===r||(n=o.charCodeAt(0),i=r.charCodeAt(0),n<=90&&97<=i?o===r.toUpperCase():i<=90&&97<=n&&r===o.toUpperCase())}function o(e,t,n){e[n]!==t[n]&&(e[n]=t[n],e[n]?e.setAttribute(n,""):e.removeAttribute(n))}var x,M={OPTION:function(e,t){var n,i=e.parentNode;i&&("OPTGROUP"===(n=i.nodeName.toUpperCase())&&(n=(i=i.parentNode)&&i.nodeName.toUpperCase()),"SELECT"!==n||i.hasAttribute("multiple")||(e.hasAttribute("selected")&&!t.selected&&(e.setAttribute("selected","selected"),e.removeAttribute("selected")),i.selectedIndex=-1)),o(e,t,"selected")},INPUT:function(e,t){o(e,t,"checked"),o(e,t,"disabled"),e.value!==t.value&&(e.value=t.value),t.hasAttribute("value")||e.removeAttribute("value")},TEXTAREA:function(e,t){var n=t.value;e.value!==n&&(e.value=n);var i=e.firstChild;if(i){var o=i.nodeValue;if(o==n||!n&&o==e.placeholder)return;i.nodeValue=n}},SELECT:function(e,t){if(!t.hasAttribute("multiple")){for(var n,i,o=-1,r=0,s=e.firstChild;s;)if("OPTGROUP"===(i=s.nodeName&&s.nodeName.toUpperCase()))s=(n=s).firstChild;else{if("OPTION"===i){if(s.hasAttribute("selected")){o=r;break}r++}!(s=s.nextSibling)&&n&&(s=n.nextSibling,n=null)}e.selectedIndex=o}}};function L(){}function V(e){if(e)return e.getAttribute&&e.getAttribute("id")||e.id}return x=function(e,t){var n,i,o,r,s=t.attributes;if(11!==t.nodeType&&11!==e.nodeType){for(var a=s.length-1;0<=a;a--)i=(n=s[a]).name,o=n.namespaceURI,r=n.value,o?(i=n.localName||i,e.getAttributeNS(o,i)!==r&&("xmlns"===n.prefix&&(i=n.name),e.setAttributeNS(o,i,r))):e.getAttribute(i)!==r&&e.setAttribute(i,r);for(var l=e.attributes,c=l.length-1;0<=c;c--)i=(n=l[c]).name,(o=n.namespaceURI)?(i=n.localName||i,t.hasAttributeNS(o,i)||e.removeAttributeNS(o,i)):t.hasAttribute(i)||e.removeAttribute(i)}},function(e,t,n){var i;n=n||{},"string"==typeof t&&("#document"===e.nodeName||"HTML"===e.nodeName||"BODY"===e.nodeName?(i=t,(t=O.createElement("html")).innerHTML=i):t=w(t));var f=n.getNodeKey||V,m=n.onBeforeNodeAdded||L,v=n.onNodeAdded||L,o=n.onBeforeElUpdated||L,r=n.onElUpdated||L,s=n.onBeforeNodeDiscarded||L,a=n.onNodeDiscarded||L,l=n.onBeforeElChildrenUpdated||L,c=!0===n.childrenOnly,p=Object.create(null),u=[];function y(e){u.push(e)}function b(e,t,n){!1!==s(e)&&(t&&t.removeChild(e),a(e),function e(t,n){if(1===t.nodeType)for(var i=t.firstChild;i;){var o=void 0;n&&(o=f(i))?y(o):(a(i),i.firstChild&&e(i,n)),i=i.nextSibling}}(e,n))}function E(e,t,n){var i=f(t);if(i&&delete p[i],!n){if(!1===o(e,t))return;if(x(e,t),r(e),!1===l(e,t))return}"TEXTAREA"!==e.nodeName?function(e,t){var n,i,o,r,s,a,l=t.firstChild,c=e.firstChild;e:for(;l;){for(r=l.nextSibling,n=f(l);c;){if(o=c.nextSibling,l.isSameNode&&l.isSameNode(c)){l=r,c=o;continue e}i=f(c);var u=c.nodeType,d=void 0;if(u===l.nodeType&&(1===u?(n?n!==i&&((s=p[n])&&o!==s?(e.insertBefore(s,c),i?y(i):b(c,e,!0),c=s):d=!1):i&&(d=!1),(d=!1!==d&&U(c,l))&&E(c,l)):3!==u&&8!=u||(d=!0,c.nodeValue!==l.nodeValue&&(c.nodeValue=l.nodeValue))),d){l=r,c=o;continue e}i?y(i):b(c,e,!0),c=o}n&&(s=p[n])&&U(s,l)?(e.appendChild(s),E(s,l)):!1!==(a=m(l))&&(a&&(l=a),l.actualize&&(l=l.actualize(e.ownerDocument||O)),e.appendChild(l),function e(t){v(t);for(var n=t.firstChild;n;){var i,o=n.nextSibling,r=f(n);r&&(i=p[r])&&U(n,i)?(n.parentNode.replaceChild(i,n),E(i,n)):e(n),n=o}}(l)),l=r,c=o}!function(e,t,n){for(;t;){var i=t.nextSibling;(n=f(t))?y(n):b(t,e,!0),t=i}}(e,c,i);var h=M[e.nodeName];h&&h(e,t)}(e,t):e.innerHTML!=t.innerHTML&&M.TEXTAREA(e,t)}!function e(t){if(1===t.nodeType||11===t.nodeType)for(var n=t.firstChild;n;){var i=f(n);i&&(p[i]=n),e(n),n=n.nextSibling}}(e);var d,h,g=e,k=g.nodeType,T=t.nodeType;if(!c)if(1===k)1===T?U(e,t)||(a(e),g=function(e,t){for(var n=e.firstChild;n;){var i=n.nextSibling;t.appendChild(n),n=i}return t}(e,(d=t.nodeName,(h=t.namespaceURI)&&h!==S?O.createElementNS(h,d):O.createElement(d)))):g=t;else if(3===k||8===k){if(T===k)return g.nodeValue!==t.nodeValue&&(g.nodeValue=t.nodeValue),g;g=t}if(g===t)a(e);else{if(t.isSameNode&&t.isSameNode(g))return;if(E(g,t,c),u)for(var N=0,C=u.length;N<C;N++){var A=p[u[N]];A&&b(A,A.parentNode,!1)}}return!c&&g!==e&&e.parentNode&&(g.actualize&&(g=g.actualize(e.ownerDocument||O)),e.parentNode.replaceChild(g,e)),g}});